<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Computer Use Backend Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Arial;
        margin: 16px;
      }
      .row {
        display: flex;
        gap: 16px;
      }
      .col {
        flex: 1;
      }
      iframe {
        width: 100%;
        height: 520px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }

      /* ✅ Live Events (SSE) styling */
      pre {
        height: 260px;
        overflow-y: auto;
        overflow-x: hidden;

        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        background: #fafafa;

        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 12px;
        line-height: 1.45;

        white-space: pre-wrap;
        word-break: break-word;

        overscroll-behavior: contain;
      }

      input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      .small {
        color: #666;
        font-size: 12px;
      }
      .box {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 10px;
      }
      code {
        background: #f3f3f3;
        padding: 2px 6px;
        border-radius: 6px;
      }

      /* Status badge */
      .badge {
        display: inline-block;
        margin-left: 10px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #ddd;
        user-select: none;
      }
      .badge-idle { background: #f5f5f5; }
      .badge-busy { background: #fff3cd; border-color: #ffe69c; }
      .badge-failed { background: #f8d7da; border-color: #f1aeb5; }
      .badge-stopped { background: #e2e3e5; border-color: #d3d6d8; }
      .badge-queued { background: #d1ecf1; border-color: #bee5eb; }

      a { color: #0b5fff; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <h2>Computer Use Agent — Session Demo</h2>

    <div class="box">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="newSession">New session</button>
        <button id="stopSession" disabled>Stop session</button>
        <button id="clearSession">Clear session</button>

        <div>
          Session ID: <b id="sid">-</b>
          <span id="badge" class="badge badge-idle">—</span>
        </div>
      </div>

      <div class="small" style="margin-top:6px;">
        SSE: <span id="sseStatus">disconnected</span> · VM:
        <span id="vmStatus">-</span>
      </div>

      <div
        id="lastErrorBox"
        class="small"
        style="margin-top:4px; color:#b00020; display:none;"
      >
        ❌ Last error: <span id="lastErrorText"></span>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="col">
        <h3>Desktop (noVNC)</h3>

        <div class="box" style="margin-bottom:10px;">
          <div class="small">Desktop URL (noVNC):</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:4px;">
            <a id="novncLink" href="#" target="_blank" rel="noopener noreferrer">Open desktop in new tab</a>
            <span class="small" id="novncUrlText">-</span>
          </div>
          <div class="small" style="margin-top:6px;">
            Note: embedding noVNC in an iframe is often blocked by X-Frame-Options / CSP. Opening in a new tab is the reliable approach.
          </div>
        </div>

        <!-- Best-effort: may remain blank due to iframe restrictions -->
        <iframe id="novnc" src="about:blank"></iframe>

        <div class="small">
          If the desktop doesn’t load, ensure session creation succeeded and ports are mapped.
        </div>

        <h3 style="margin-top:16px;">Reviewer CURLs</h3>
        <pre id="curlBox" class="small">(create a session to see curl commands)</pre>
      </div>

      <div class="col">
        <h3>Live Events (SSE)</h3>
        <pre id="events"></pre>

        <h3 style="margin-top:16px;">Chat</h3>
        <div class="box">
          <div
            id="history"
            class="small"
            style="white-space:pre-wrap; margin-bottom:10px;"
          ></div>
          <div style="display:flex; gap:10px;">
            <input id="msg" placeholder="e.g. Open browser and search for ..." />
            <button id="send" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "computer_use_demo_session_id";
      let sessionId = null;
      let es = null;

      const $ = (id) => document.getElementById(id);

      // Base URL (works for localhost and deployed)
      function baseUrl() {
        return window.location.origin;
      }

      function setCurlBox(id) {
        if (!id) {
          $("curlBox").textContent = "(create a session to see curl commands)";
          return;
        }
        const B = baseUrl();
        $("curlBox").textContent =
`# Create session
curl -s -X POST ${B}/v1/sessions | python -m json.tool

# Stream events (SSE)
curl -N ${B}/v1/sessions/${id}/events

# Send message
curl -s -X POST ${B}/v1/sessions/${id}/messages \\
  -H "Content-Type: application/json" \\
  -d '{"content":"Open browser and search for..."}' | python -m json.tool

# Get chat history
curl -s ${B}/v1/sessions/${id}/history | python -m json.tool

# Stop session
curl -s -X POST ${B}/v1/sessions/${id}/stop | python -m json.tool
`;
      }

      // ✅ Better logging: auto-scroll only if user is at bottom + cap size
      function log(line) {
        const el = $("events");
        const atBottom =
          el.scrollTop + el.clientHeight >= el.scrollHeight - 10;

        el.textContent += line + "\n";
        if (line.startsWith("STATUS")) el.textContent += "\n";

        // Cap log size (prevents UI slowdown)
        const MAX_LINES = 350;
        const lines = el.textContent.split("\n");
        if (lines.length > MAX_LINES) {
          el.textContent = lines.slice(-MAX_LINES).join("\n");
        }

        if (atBottom) {
          el.scrollTop = el.scrollHeight;
        }
      }

      function setSse(v) { $("sseStatus").textContent = v; }
      function setVm(v) { $("vmStatus").textContent = v || "-"; }

      function setBadge(text, cls) {
        $("badge").textContent = text;
        $("badge").className = `badge ${cls}`;
      }

      function hideLastError() {
        $("lastErrorBox").style.display = "none";
        $("lastErrorText").textContent = "";
      }

      function showLastError(msg) {
        $("lastErrorText").textContent = msg || "(unknown error)";
        $("lastErrorBox").style.display = "block";
      }

      function setNoVncUrl(url) {
        const u = url || "";
        $("novncUrlText").textContent = u || "-";

        const link = $("novncLink");
        if (u) {
          link.href = u;
          link.style.pointerEvents = "auto";
          link.style.opacity = "1";
        } else {
          link.href = "#";
          link.style.pointerEvents = "none";
          link.style.opacity = "0.6";
        }

        // Best-effort iframe (often blocked)
        $("novnc").src = u || "about:blank";
      }

      async function loadSessionMeta() {
        const r = await fetch(`/v1/sessions/${sessionId}`);
        if (!r.ok) throw new Error("Session not found");
        return await r.json();
      }

      function applySessionStatus(status) {
        setVm(status);

        if (!sessionId) {
          setBadge("—", "badge-idle");
          $("send").disabled = true;
          hideLastError();
          return;
        }

        if (status === "running") {
          setBadge("BUSY", "badge-busy");
          $("send").disabled = true;
          hideLastError();
        } else if (status === "queued") {
          setBadge("QUEUED", "badge-queued");
          $("send").disabled = true;
          hideLastError();
        } else if (status === "failed") {
          setBadge("FAILED", "badge-failed");
          $("send").disabled = true;
          loadSessionMeta()
            .then(m => showLastError(m.last_error))
            .catch(() => showLastError("Session failed"));
        } else if (status === "stopped") {
          setBadge("STOPPED", "badge-stopped");
          $("send").disabled = true;
          hideLastError();
        } else {
          setBadge("IDLE", "badge-idle");
          $("send").disabled = false;
          hideLastError();
        }
      }

      function connectSse() {
        if (es) es.close();
        setSse("connecting");
        es = new EventSource(`/v1/sessions/${sessionId}/events`);
        es.onopen = () => setSse("connected");
        es.onerror = () => setSse("error");

        ["status","token","tool_call","screenshot","log","message"].forEach(t =>
          es.addEventListener(t, e => {
            log(`${t.toUpperCase()} ${e.data}`);
            if (t === "status") {
              try { applySessionStatus(JSON.parse(e.data).status); } catch {}
            }
            if (t === "message") loadHistory();
          })
        );
      }

      async function loadHistory() {
        const r = await fetch(`/v1/sessions/${sessionId}/history`);
        if (!r.ok) return;
        const h = await r.json();
        $("history").textContent = h.map(m => `${m.role}: ${m.content}`).join("\n\n");
      }

      async function activateSession(id) {
        sessionId = id;
        localStorage.setItem(STORAGE_KEY, id);
        $("sid").textContent = id;

        setCurlBox(id); // ✅ populate reviewer curls immediately

        const meta = await loadSessionMeta();
        setNoVncUrl(meta.novnc_url);
        $("stopSession").disabled = false;

        applySessionStatus(meta.status);
        connectSse();
        loadHistory();
      }

      $("newSession").onclick = async () => {
        const r = await fetch("/v1/sessions", { method: "POST" });
        const s = await r.json();
        activateSession(s.id);
      };

      $("send").onclick = async () => {
        const c = $("msg").value.trim();
        if (!c) return;
        $("send").disabled = true;
        $("msg").value = "";
        await fetch(`/v1/sessions/${sessionId}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: c })
        });
        applySessionStatus("queued");
      };

      $("stopSession").onclick = async () => {
        await fetch(`/v1/sessions/${sessionId}/stop`, { method: "POST" });
        if (es) es.close();
        applySessionStatus("stopped");
      };

      $("clearSession").onclick = () => {
        if (es) es.close();
        sessionId = null;
        localStorage.removeItem(STORAGE_KEY);
        setCurlBox(null);
        location.reload();
      };

      (async function init() {
        setNoVncUrl("");
        setCurlBox(null);
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) activateSession(saved);
      })();
    </script>
  </body>
</html>
