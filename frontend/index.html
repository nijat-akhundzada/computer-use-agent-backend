<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Computer Use Backend Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Arial;
        margin: 16px;
      }
      .row {
        display: flex;
        gap: 16px;
      }
      .col {
        flex: 1;
      }
      iframe {
        width: 100%;
        height: 520px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }

      /* Logs / SSE + curls */
      pre {
        height: 260px;
        overflow-y: auto;
        overflow-x: hidden;

        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        background: #fafafa;

        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 12px;
        line-height: 1.45;

        white-space: pre-wrap;
        word-break: break-word;
        overscroll-behavior: contain;
      }

      input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      .small {
        color: #666;
        font-size: 12px;
      }
      .box {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 10px;
      }
      code {
        background: #f3f3f3;
        padding: 2px 6px;
        border-radius: 6px;
      }

      /* Status badge */
      .badge {
        display: inline-block;
        margin-left: 10px;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #ddd;
        user-select: none;
      }
      .badge-idle { background: #f5f5f5; }
      .badge-busy { background: #fff3cd; border-color: #ffe69c; }
      .badge-failed { background: #f8d7da; border-color: #f1aeb5; }
      .badge-stopped { background: #e2e3e5; border-color: #d3d6d8; }
      .badge-queued { background: #d1ecf1; border-color: #bee5eb; }

      a { color: #0b5fff; text-decoration: none; }
      a:hover { text-decoration: underline; }

      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

      /* ✅ Chat bubbles */
      #historyBox {
        height: 260px;
        overflow: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 10px;
        background: #fff;
        overscroll-behavior: contain;
      }

      #historyList {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .msg-row {
        display: flex;
      }

      .msg-row.user {
        justify-content: flex-end;
      }

      .msg-row.assistant {
        justify-content: flex-start;
      }

      .bubble {
        max-width: 82%;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid #e5e5e5;
        background: #f7f7f8;
        box-shadow: 0 1px 0 rgba(0,0,0,0.02);
      }

      .msg-row.user .bubble {
        background: #e9f2ff;
        border-color: #cfe2ff;
      }

      .bubble-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 6px;
      }

      .role-pill {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #ddd;
        background: #fff;
        color: #555;
      }

      .msg-row.user .role-pill {
        border-color: #cfe2ff;
      }

      .time {
        font-size: 11px;
        color: #888;
        white-space: nowrap;
      }

      .bubble-body {
        font-size: 13px;
        line-height: 1.45;
        color: #111;
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
  </head>

  <body>
    <h2>Computer Use Agent — Session Demo</h2>

    <div class="box">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="newSession">New session</button>
        <button id="stopSession" disabled>Stop session</button>
        <button id="clearSession">Clear session</button>

        <div>
          Session ID: <b id="sid">-</b>
          <span id="badge" class="badge badge-idle">—</span>
        </div>
      </div>

      <div class="small" style="margin-top:6px;">
        SSE: <span id="sseStatus">disconnected</span> · VM:
        <span id="vmStatus">-</span>
      </div>

      <div
        id="lastErrorBox"
        class="small"
        style="margin-top:4px; color:#b00020; display:none;"
      >
        ❌ Last error: <span id="lastErrorText"></span>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="col">
        <h3>Desktop (noVNC)</h3>

        <div class="box" style="margin-bottom:10px;">
          <div class="small">Desktop URL (noVNC):</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:4px;">
            <a id="novncLink" href="#" target="_blank" rel="noopener noreferrer">Open desktop in new tab</a>
            <span class="small mono" id="novncUrlText">-</span>
          </div>
          <div class="small" style="margin-top:6px;">
            Note: embedding noVNC in an iframe is often blocked by X-Frame-Options / CSP. Opening in a new tab is the reliable approach.
          </div>
        </div>

        <!-- Best-effort: may remain blank due to iframe restrictions -->
        <iframe id="novnc" src="about:blank"></iframe>

        <div class="small">
          If the desktop doesn’t load, ensure session creation succeeded and ports are mapped.
        </div>

        <h3 style="margin-top:16px;">Reviewer CURLs</h3>
        <pre id="curlBox" class="small">(create a session to see curl commands)</pre>
      </div>

      <div class="col">
        <h3>Live Events (SSE)</h3>
        <pre id="events"></pre>

        <h3 style="margin-top:16px;">Chat</h3>
        <div class="box">
          <div class="small" style="margin-bottom:6px;">
            History <span class="small" style="color:#999;">(persisted)</span>
          </div>

          <div id="historyBox">
            <div id="historyList">
              <div class="small" style="color:#777;">(no messages yet)</div>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:10px;">
            <input id="msg" placeholder="e.g. Open browser and search for ..." />
            <button id="send" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "computer_use_demo_session_id";
      let sessionId = null;
      let es = null;

      const $ = (id) => document.getElementById(id);

      function baseUrl() {
        return window.location.origin;
      }

      function setCurlBox(id) {
        if (!id) {
          $("curlBox").textContent = "(create a session to see curl commands)";
          return;
        }
        const B = baseUrl();
        $("curlBox").textContent =
`# Create session
curl -s -X POST ${B}/v1/sessions | python -m json.tool

# Stream events (SSE)
curl -N ${B}/v1/sessions/${id}/events

# Send message
curl -s -X POST ${B}/v1/sessions/${id}/messages \\
  -H "Content-Type: application/json" \\
  -d '{"content":"Open browser and search for..."}' | python -m json.tool

# Get chat history
curl -s ${B}/v1/sessions/${id}/history | python -m json.tool

# Stop session
curl -s -X POST ${B}/v1/sessions/${id}/stop | python -m json.tool
`;
      }

      // ✅ SSE log: auto-scroll only if user at bottom + cap size
      function log(line) {
        const el = $("events");
        const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 10;

        el.textContent += line + "\n";
        if (line.startsWith("STATUS")) el.textContent += "\n";

        const MAX_LINES = 350;
        const lines = el.textContent.split("\n");
        if (lines.length > MAX_LINES) el.textContent = lines.slice(-MAX_LINES).join("\n");

        if (atBottom) el.scrollTop = el.scrollHeight;
      }

      function setSse(v) { $("sseStatus").textContent = v; }
      function setVm(v) { $("vmStatus").textContent = v || "-"; }

      function setBadge(text, cls) {
        $("badge").textContent = text;
        $("badge").className = `badge ${cls}`;
      }

      function hideLastError() {
        $("lastErrorBox").style.display = "none";
        $("lastErrorText").textContent = "";
      }

      function showLastError(msg) {
        $("lastErrorText").textContent = msg || "(unknown error)";
        $("lastErrorBox").style.display = "block";
      }

      function setNoVncUrl(url) {
        const u = url || "";
        $("novncUrlText").textContent = u || "-";

        const link = $("novncLink");
        if (u) {
          link.href = u;
          link.style.pointerEvents = "auto";
          link.style.opacity = "1";
        } else {
          link.href = "#";
          link.style.pointerEvents = "none";
          link.style.opacity = "0.6";
        }

        // Best-effort iframe (often blocked)
        $("novnc").src = u || "about:blank";
      }

      async function loadSessionMeta() {
        const r = await fetch(`/v1/sessions/${sessionId}`);
        if (!r.ok) throw new Error("Session not found");
        return await r.json();
      }

      function formatTime(iso) {
        try {
          const d = new Date(iso);
          return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        } catch {
          return "";
        }
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function loadHistory() {
        if (!sessionId) return;

        const r = await fetch(`/v1/sessions/${sessionId}/history`);
        if (!r.ok) return;

        let items = await r.json();
        const list = $("historyList");
        const box = $("historyBox");

        if (!items || items.length === 0) {
          list.innerHTML = `<div class="small" style="color:#777;">(no messages yet)</div>`;
          return;
        }

        const atBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 10;

        list.innerHTML = items.map((m) => {
          const role = m.role === "user" ? "user" : "assistant";
          const roleLabel = role === "user" ? "user" : "assistant";
          const time = m.created_at ? formatTime(m.created_at) : "";
          const content = escapeHtml(m.content);

          return `
            <div class="msg-row ${role}">
              <div class="bubble">
                <div class="bubble-head">
                  <span class="role-pill">${roleLabel}</span>
                  <span class="time">${time}</span>
                </div>
                <div class="bubble-body">${content}</div>
              </div>
            </div>
          `;
        }).join("");

        if (atBottom) box.scrollTop = box.scrollHeight;
      }

      function applySessionStatus(status) {
        setVm(status);

        if (!sessionId) {
          setBadge("—", "badge-idle");
          $("send").disabled = true;
          hideLastError();
          return;
        }

        if (status === "running") {
          setBadge("BUSY", "badge-busy");
          $("send").disabled = true;
          hideLastError();
        } else if (status === "queued") {
          setBadge("QUEUED", "badge-queued");
          $("send").disabled = true;
          hideLastError();
        } else if (status === "failed") {
          setBadge("FAILED", "badge-failed");
          $("send").disabled = true;
          loadSessionMeta()
            .then((m) => showLastError(m.last_error))
            .catch(() => showLastError("Session failed"));
          loadHistory();
        } else if (status === "stopped") {
          setBadge("STOPPED", "badge-stopped");
          $("send").disabled = true;
          hideLastError();
          loadHistory();
        } else {
          setBadge("IDLE", "badge-idle");
          $("send").disabled = false;
          hideLastError();
          loadHistory();
        }
      }

      function connectSse() {
        if (es) es.close();
        setSse("connecting");

        es = new EventSource(`/v1/sessions/${sessionId}/events`);
        es.onopen = () => setSse("connected");
        es.onerror = () => setSse("error");

        ["status","token","tool_call","screenshot","log","message"].forEach((t) =>
          es.addEventListener(t, (e) => {
            log(`${t.toUpperCase()} ${e.data}`);
            if (t === "status") {
              try { applySessionStatus(JSON.parse(e.data).status); } catch {}
            }
            if (t === "message") loadHistory();
          })
        );
      }

      async function activateSession(id) {
        sessionId = id;
        localStorage.setItem(STORAGE_KEY, id);
        $("sid").textContent = id;

        setCurlBox(id);

        const meta = await loadSessionMeta();
        setNoVncUrl(meta.novnc_url);
        $("stopSession").disabled = false;

        applySessionStatus(meta.status);
        connectSse();
        await loadHistory();
      }

      $("newSession").onclick = async () => {
        const r = await fetch("/v1/sessions", { method: "POST" });
        if (!r.ok) {
          log("Failed to create session");
          return;
        }
        const s = await r.json();
        activateSession(s.id);
      };

      $("send").onclick = async () => {
        const c = $("msg").value.trim();
        if (!c) return;

        $("send").disabled = true;
        $("msg").value = "";

        const r = await fetch(`/v1/sessions/${sessionId}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: c })
        });

        if (!r.ok) {
          const text = await r.text().catch(() => "");
          log("Failed to send message: " + text);
          $("send").disabled = false;
          return;
        }

        await loadHistory();
        applySessionStatus("queued");
      };

      $("stopSession").onclick = async () => {
        await fetch(`/v1/sessions/${sessionId}/stop`, { method: "POST" });
        if (es) es.close();
        applySessionStatus("stopped");
      };

      $("clearSession").onclick = () => {
        if (es) es.close();
        es = null;
        sessionId = null;
        localStorage.removeItem(STORAGE_KEY);
        setNoVncUrl("");
        setCurlBox(null);
        $("events").textContent = "";
        $("historyList").innerHTML = `<div class="small" style="color:#777;">(no messages yet)</div>`;
        setSse("disconnected");
        setVm("-");
        setBadge("—", "badge-idle");
        hideLastError();
        $("stopSession").disabled = true;
        $("send").disabled = true;
        $("sid").textContent = "-";
      };

      (async function init() {
        setNoVncUrl("");
        setCurlBox(null);

        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          log("Restoring session: " + saved);
          await activateSession(saved);
        }
      })();
    </script>
  </body>
</html>